\section{Boundary error correction for staggered grids}\label{sec:boundary-correction}

The marker-and-cell (MAC) grid~\cite{Welch:1965jv} is a popular method for fluid
simulations. Components of vector-valued quantities are discretized at the center of the
corresponding cell faces and scalar-valued quantities at the cell center. This
staggering is a distinguishing feature of the MAC grid. Staggering avoids the
checkerboard instability that arises from using collocated grids~\cite{Wesseling:2001ci}. 
However, in domains with non-periodic boundaries, this means that some vector components
will encounter situations where satisfying boundary conditions with linear ghost value
extrapolation leads to numerical error. This appendix explores these errors and provides
a resolution that maintains compatibility with the conjugate gradients method.

For a rectangular domain with Dirichlet boundary conditions along its top and bottom and
periodic boundaries elsewhere, consider a region of the domain adjacent to a boundary.
The horizontal component of the fluid velocity, $u$, is discretized at locations
staggered $h/2$ vertically above the bottom of a grid cell, or below the top of a grid
cell, as seen in Figure~\ref{fig:discretization}(b). We have boundary data for $u$ along
the boundary at the same $x$ and $z$ coordinates as the grid points. Using a linear
interpolant to fill a value at the ghost cell $h/2$ below the bottom boundary yields
\begin{equation}\label{eq:ghost}
    u_{i,\,-1,\,k} = 2\gamma_{i,\,k} - u_{i,\,0,\,k},
\end{equation}
where $u_{i,\,-1,\,k}$ is the value at the ghost cell, $\gamma_{i,\,k}$ is the boundary
datum, and $u_{i,\,1,\,k}$ is the value at the grid point within the domain. Using the
standard 7-point Laplacian then yields
\begin{equation}\label{eq:disc-lap}
    \begin{aligned}
        (\laplacian_h \arr{u})_{i,\,0,\,k}
        &= (D_{xx}\arr{u})_{i,\,0,\,k} + h^{-2}\left[u_{i,\,-1,\,k} - 2u_{i,\,0,\,k} + u_{i,\,1,\,k}\right] + (D_{zz}\arr{u})_{i,\,0,\,k} \\
        &= (D_{xx}\arr{u})_{i,\,0,\,k} + h^{-2}\left[2\gamma_{i,\,k} - 3u_{i,\,0,\,k} + u_{i,\,1,\,k}\right] + (D_{zz}\arr{u})_{i,\,0,\,k},
    \end{aligned}
\end{equation}
where $\arr{u}$ is the vector of $u_{i,\,j,\,k}$ values and $D_{xx}$ and $D_{zz}$ are the
standard 3-point discrete second derivative operators with respect to $x$ and $z$,
respectively. Because $D_{xx}\arr{u}$ and $D_{zz}\arr{u}$ only involve values at points
within the domain, they are known to approximate their continuous counterparts to second
order. We therefore focus on the remaining term. Replacing $u_{i,\,j,\,k}$ with
$u(hi,\,h(j+0.5),\,h(k+0.5))$ and Taylor expanding about $(hi,\,0.5h,\,h(k+0.5))$ yields
\begin{equation}\label{eq:expansion}
    \begin{aligned}
    h^{-2}\left[2\gamma_{i,\,k} - 3u_{i,\,0,\,k} + u_{i,\,1,\,k}\right]
    &= h^{-2}\left[2\left(u - \frac{h}{2}u_y + \frac{h^2}{8}u_{yy} - \frac{h^3}{48}u_{yyy}\right) - 3u\right. \\
    &\hphantom{=h^{-2}[}\left.+ \left(u + hu_y + \frac{h^2}{2}u_{yy} - \frac{h^3}{6}u_{yyy}\right)+\mathcal{O}(h^4)\right] \\
    &= \frac34u_{yy} - \frac{5h}{24}u_{yyy} + \mathcal{O}(h^2),
    \end{aligned}
\end{equation}
\latin{i.e.}, the leading coefficient is $3/4$ where we expect 1, meaning we obtain a
0\textsuperscript{th}-order approximation to $u_{yy}$ near the boundary. The case is the
same for the upper boundary.

Correcting this while maintaining symmetry of the $\laplacian_h$ operator is not as easy
as using a second order interpolant for the ghost cell value or scaling the stencil for
$D_{yy}$ near the boundary by $4/3$. Either of these options changes the weight of
$u_{i,\,1,\,k}$, which destroys symmetry. Instead, we scale any equation involving a
ghost cell by $3/4$, excluding the bracketed terms in~\eqref{eq:disc-lap}. We define the
modified identity operator $\tilde{I}$, which has a value of $3/4$ on the diagonal for
rows corresponding to near-boundary equations and 1 elsewhere on the diagonal. We define
the modified discrete Laplacian
\begin{equation}\label{eq:mod-disc-lap}
    \tilde{\laplacian}_h = \tilde{I}D_{xx} + D_{yy} + \tilde{I}D_{zz},
\end{equation}
where, away from the boundary, $D_{yy}$ is the standard 3-point discrete second
derivative with respect to $y$, and defined according to~\eqref{eq:disc-lap} otherwise.
The resulting $D_{yy}$ is symmetric. In addition to replacing the discrete Laplacian
$\laplacian_h$ with $\tilde{\laplacian}_h$, a timestepping scheme using this correction
must replace instances of the identity matrix, many of which not written explicity, with
the modified identity $\tilde{I}$. A stage of such a timestepping scheme takes the form
\begin{equation*}
    (\tilde{I} - \alpha k\tilde{\laplacian}_h)\arr{u}^n = (\tilde{I} + (1-\alpha)k\tilde{\laplacian}_h)\arr{u}^{n-1} + B_h\arr{\gamma} + \tilde{I}\arr{f},
\end{equation*}
where $\alpha$ is either 0.5 or 1, depending on the scheme and stage, and $B_h$ is an
appropriate operator that modifies equations near the boundary with boundary data. This
corrected scheme involves modified operators, but requires only an additional diagonal
multiplication compared to the uncorrected scheme. The Helmholtz operator on the
left-hand side remains symmetric positive definite after correction, and is therefore
suitable for solution via conjugate gradients.

% vim: cc=90 tw=89
